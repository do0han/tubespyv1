'use client';

import { useSession } from 'next-auth/react';
import { Session } from 'next-auth';
import { useEffect, useState } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Youtube, BarChart3, TrendingUp, Users, Eye, Loader2, Search, Play, ThumbsUp, MessageCircle, Calendar, ArrowUpDown, ChevronUp, ChevronDown, Download, Star, Target, TrendingDown } from 'lucide-react';
import { DashboardHeader } from './components/dashboard-header';
import { YouTubeChannel } from '@/lib/youtube';

// YouTube ÏòÅÏÉÅ ÌÉÄÏûÖ Ï†ïÏùò
interface YouTubeVideo {
  id: string;
  title: string;
  description: string;
  thumbnails: {
    default: { url: string };
    medium: { url: string };
    high: { url: string };
  };
  publishedAt: string;
  channelTitle: string;
  channelId: string;
  duration: string;
  viewCount: string;
  likeCount: string;
  commentCount: string;
  tags?: string[];
  subscriberCount: string;
  totalVideos: string;
  channelContribution: string;
  performanceMultiplier: string;
  cii: string;
  engagementRate: string;
  subtitles: string;
  rawViewCount: number;
  rawLikeCount: number;
  rawCommentCount: number;
  rawSubscriberCount: number;
  rawTotalVideos: number;
}

type SortField = 'title' | 'channelTitle' | 'viewCount' | 'likeCount' | 'commentCount' | 'publishedAt' | 'duration' | 'subscriberCount' | 'channelContribution' | 'performanceMultiplier' | 'cii' | 'engagementRate';
type SortDirection = 'asc' | 'desc';

export default function DashboardPage() {
  const { data: session, status } = useSession();
  const [channels, setChannels] = useState<YouTubeChannel[]>([]);
  const [searchResults, setSearchResults] = useState<YouTubeVideo[]>([]);
  const [loading, setLoading] = useState(true);
  const [searching, setSearching] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [sortField, setSortField] = useState<SortField>('viewCount');
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');

  useEffect(() => {
    if (status === 'authenticated' && session) {
      fetchChannels();
    }
  }, [status, session]);

  const fetchChannels = async () => {
    if (!session) return;
    
    try {
      setLoading(true);
      setError(null);
      
      // ÏûÑÏãú Î™®ÌÇπ Îç∞Ïù¥ÌÑ∞ - Ïã§Ï†ú YouTube API ÎåÄÏã† ÏÇ¨Ïö©
      console.log('üöÄ ÏûÑÏãú Î™®ÌÇπ Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏãúÎ≥¥Îìú ÌëúÏãú');
      
      const mockChannels: YouTubeChannel[] = [
        {
          id: 'UC_mock_channel_id',
          title: 'doo han yoon',
          description: 'YouTube Ï±ÑÎÑêÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!',
          thumbnails: {
            default: { url: session.user?.image || '/default-avatar.png' },
            medium: { url: session.user?.image || '/default-avatar.png' },
            high: { url: session.user?.image || '/default-avatar.png' }
          },
          publishedAt: '2020-01-01T00:00:00Z',
          subscriberCount: '156',
          videoCount: '23',
          viewCount: '15420'
        }
      ];
      
      setChannels(mockChannels);
      console.log('‚úÖ Î™®ÌÇπ Ï±ÑÎÑê Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', mockChannels.length);
      
    } catch (err) {
      setError('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
      console.error('Ï±ÑÎÑê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', err);
    } finally {
      setLoading(false);
    }
  };

  const searchVideos = async () => {
    if (!searchQuery.trim()) return;
    
    try {
      setSearching(true);
      setError(null);
      
      console.log('üîç Ïã§Ï†ú YouTube API Ìò∏Ï∂ú:', searchQuery);
      
      // Ïã§Ï†ú YouTube API Ìò∏Ï∂ú
      const response = await fetch(`/api/youtube/videos?q=${encodeURIComponent(searchQuery)}&maxResults=50`);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'YouTube API Ìò∏Ï∂ú Ïã§Ìå®');
      }
      
      if (data.usesFallback) {
        console.log('‚ö†Ô∏è API Ìï†ÎãπÎüâ Ï¥àÍ≥º - ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©');
        setError('YouTube API Ìï†ÎãπÎüâ Ï¥àÍ≥º - ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞Î•º ÌëúÏãúÌï©ÎãàÎã§');
      } else {
        console.log(`‚úÖ Ïã§Ï†ú YouTube Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ${data.videos.length}Í∞ú`);
      }
      
      setSearchResults(data.videos || []);
      
    } catch (error: any) {
      console.error('‚ùå YouTube API Ìò∏Ï∂ú Ïã§Ìå®:', error);
      setError(`Í≤ÄÏÉâ Ïã§Ìå®: ${error.message}`);
      
      // ÏóêÎü¨ Î∞úÏÉùÏãú ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏ≤¥
      console.log('üîÑ ÏóêÎü¨ Î∞úÏÉù - ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏ≤¥');
      const fallbackVideos = generateFallbackVideos(searchQuery);
      setSearchResults(fallbackVideos);
      
    } finally {
      setSearching(false);
    }
  };

  // ÏóêÎü¨Ïãú ÏÇ¨Ïö©Ìï† ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò (Ïª¥Ìè¨ÎÑåÌä∏ ÎÇ¥Î∂ÄÏö©)
  const generateFallbackVideos = (query: string) => {
    const channels = [
      { name: 'ÌîÑÎ°ú ÌäúÌÜ†Î¶¨Ïñº', subscribers: 125000, videos: 234 },
      { name: 'Ìä∏Î†åÎìú ÏõåÏπò', subscribers: 89000, videos: 156 },
      { name: 'Ïã§Î¨¥ ÍøÄÌåÅ', subscribers: 167000, videos: 89 },
      { name: 'ÎπÑÍµê Î∂ÑÏÑùÍ∞Ä', subscribers: 234000, videos: 445 },
      { name: 'Ï¥àÎ≥¥Ïûê ÏπúÌôî', subscribers: 78000, videos: 123 },
      { name: 'Ï†ÑÎ¨∏Í∞Ä Î¶¨Î∑∞', subscribers: 345000, videos: 567 },
      { name: 'Îç∞ÏùºÎ¶¨ ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞', subscribers: 56000, videos: 234 },
      { name: 'Ïä§ÎßàÌä∏ Í∞ÄÏù¥Îìú', subscribers: 198000, videos: 345 },
      { name: 'Ïù∏Í∏∞ Ïú†ÌäúÎ≤Ñ', subscribers: 567000, videos: 678 },
      { name: 'IT Îâ¥Ïä§', subscribers: 123000, videos: 234 }
    ];

    return Array.from({ length: 50 }, (_, i) => {
      const channel = channels[i % channels.length];
      const views = Math.floor(Math.random() * 5000000 + 10000);
      const likes = Math.floor(views * (Math.random() * 0.05 + 0.01));
      const comments = Math.floor(views * (Math.random() * 0.01 + 0.001));
      const channelTotalViews = channel.subscribers * 150; // Íµ¨ÎèÖÏûêÎãπ ÌèâÍ∑† 150Ìöå Ï°∞ÌöåÏàò Í∞ÄÏ†ï
      
      return {
        id: `video_${i + 1}`,
        title: `${query} Í¥ÄÎ†® ${['ÏôÑÎ≤Ω Í∞ÄÏù¥Îìú', 'Ïã§Ï†Ñ ÌôúÏö©Î≤ï', 'Ìä∏Î†åÎìú Î∂ÑÏÑù', 'ÎπÑÍµê Î¶¨Î∑∞', 'Ï¥àÎ≥¥Ïûê ÌåÅ', 'Ï†ÑÎ¨∏Í∞Ä Ìï¥ÏÑ§', 'ÏµúÏã† ÏóÖÎç∞Ïù¥Ìä∏', 'Ïã§Î¨¥ Ï†ÅÏö©', 'Ïã¨Ìôî ÌïôÏäµ', 'Í∏∞Ï¥à ÏûÖÎ¨∏'][i % 10]} - ${i + 1}Ìé∏`,
        description: `${query}Ïóê ÎåÄÌïú ÏÉÅÏÑ∏Ìïú ÏÑ§Î™ÖÍ≥º Ïã§Ïö©Ï†ÅÏù∏ ÌåÅÏùÑ Ï†úÍ≥µÌïòÎäî ÏòÅÏÉÅÏûÖÎãàÎã§.`,
        thumbnails: {
          default: { url: 'https://via.placeholder.com/120x90' },
          medium: { url: 'https://via.placeholder.com/320x180' },
          high: { url: 'https://via.placeholder.com/480x360' }
        },
        publishedAt: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString(),
        channelTitle: channel.name,
        channelId: `channel_${i % channels.length + 1}`,
        viewCount: views >= 1000000 ? `${(views / 1000000).toFixed(1)}M` : `${(views / 1000).toFixed(0)}K`,
        likeCount: likes >= 1000 ? `${(likes / 1000).toFixed(1)}K` : likes.toString(),
        commentCount: comments >= 1000 ? `${(comments / 1000).toFixed(1)}K` : comments.toString(),
        duration: `${Math.floor(Math.random() * 30 + 5)}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
        tags: [`${query}`, 'ÌäúÌÜ†Î¶¨Ïñº', 'Í∞ÄÏù¥Îìú'],
        rawViewCount: views,
        rawLikeCount: likes,
        rawCommentCount: comments,
        rawSubscriberCount: channel.subscribers,
        rawTotalVideos: channel.videos,
        subscriberCount: channel.subscribers >= 1000000 ? `${(channel.subscribers / 1000000).toFixed(1)}M` : `${(channel.subscribers / 1000).toFixed(0)}K`,
        totalVideos: channel.videos >= 1000 ? `${(channel.videos / 1000).toFixed(1)}K` : channel.videos.toString(),
        channelContribution: ((views / channelTotalViews) * 100).toFixed(2),
        performanceMultiplier: (((likes + comments) / views) * 1000).toFixed(2),
        cii: ((views / channel.subscribers) * 100).toFixed(2),
        engagementRate: (((likes + comments) / views) * 100).toFixed(2),
        subtitles: Math.random() > 0.3 ? 'ÏûàÏùå' : 'ÏóÜÏùå'
      };
    });
  };

  const handleSearchKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      searchVideos();
    }
  };

  const formatNumber = (num: string) => {
    const number = parseInt(num);
    if (number >= 1000000) {
      return `${(number / 1000000).toFixed(1)}M`;
    } else if (number >= 1000) {
      return `${(number / 1000).toFixed(1)}K`;
    }
    return number.toLocaleString();
  };

  const formatDuration = (duration: string) => {
    // Ïù¥ÎØ∏ Ìè¨Îß∑Îêú Î¨∏ÏûêÏó¥Ïù¥Î©¥ Í∑∏ÎåÄÎ°ú Î∞òÌôò
    if (duration.includes(':')) return duration;
    
    // Ï¥à Îã®ÏúÑÎ°ú Î≥ÄÌôò
    const totalSeconds = parseInt(duration);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffInDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
    
    if (diffInDays === 0) return 'Ïò§Îäò';
    if (diffInDays === 1) return '1Ïùº Ï†Ñ';
    if (diffInDays < 7) return `${diffInDays}Ïùº Ï†Ñ`;
    if (diffInDays < 30) return `${Math.floor(diffInDays / 7)}Ï£º Ï†Ñ`;
    if (diffInDays < 365) return `${Math.floor(diffInDays / 30)}Í∞úÏõî Ï†Ñ`;
    return `${Math.floor(diffInDays / 365)}ÎÖÑ Ï†Ñ`;
  };

  // ÏÑ±Í≥º Îì±Í∏â Í≥ÑÏÇ∞ Ìï®Ïàò
  const getPerformanceGrade = (views: number, likes: number, comments: number) => {
    const likeRatio = (likes / views) * 100;
    const commentRatio = (comments / views) * 100;
    const engagementScore = likeRatio + commentRatio;
    
    if (engagementScore >= 8) return { grade: 'Great!', color: 'bg-green-500', textColor: 'text-green-700' };
    if (engagementScore >= 5) return { grade: 'Good', color: 'bg-blue-400', textColor: 'text-blue-700' };
    if (engagementScore >= 2) return { grade: 'Not bad', color: 'bg-yellow-400', textColor: 'text-yellow-700' };
    return { grade: 'Bad', color: 'bg-red-500', textColor: 'text-red-700' };
  };

  // Í≤ΩÏüÅÎ†• Ï†êÏàò Í≥ÑÏÇ∞
  const getCompetitiveScore = (views: number, publishedAt: string) => {
    const daysOld = Math.floor((Date.now() - new Date(publishedAt).getTime()) / (1000 * 60 * 60 * 24));
    const dailyViews = views / Math.max(daysOld, 1);
    
    if (dailyViews >= 10000) return { score: 99, label: 'ÏµúÍ≥† Í≤ΩÏüÅÎ†•' };
    if (dailyViews >= 5000) return { score: 85, label: 'ÎÜíÏùÄ Í≤ΩÏüÅÎ†•' };
    if (dailyViews >= 1000) return { score: 65, label: 'Î≥¥ÌÜµ Í≤ΩÏüÅÎ†•' };
    if (dailyViews >= 100) return { score: 35, label: 'ÎÇÆÏùÄ Í≤ΩÏüÅÎ†•' };
    return { score: 15, label: 'Îß§Ïö∞ ÎÇÆÏùå' };
  };

  // Ï∂îÏ≤úÎèÑ Í≥ÑÏÇ∞
  const getRecommendationScore = (views: number, likes: number, comments: number) => {
    const engagement = ((likes + comments * 3) / views) * 100;
    return Math.min(Math.floor(engagement * 20), 100);
  };

  // ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ìï®Ïàò
  const exportToExcel = () => {
    if (searchResults.length === 0) {
      alert('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Í≤ÄÏÉâÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    const csvContent = [
      // Ìó§Îçî (Ïù¥ÎØ∏ÏßÄÏôÄ ÎèôÏùºÌïú Ïª¨Îüº Íµ¨ÏÑ±)
      ['ÏàúÏúÑ', 'Ï†úÎ™©', 'Ï±ÑÎÑêÎ™Ö', 'Í≤åÏãúÏùº', 'Íµ¨ÎèÖÏûêÏàò', 'Ï°∞ÌöåÏàò', 'Ï¢ãÏïÑÏöî Í∏∞Ïó¨ÎèÑ(%)', 'ÏÑ±Í≥ºÎì±Í∏â', 'CII', 'ÏòÅÏÉÅÍ∏∏Ïù¥', 'Ï¢ãÏïÑÏöîÏàò', 'Í≤ΩÏüÅÎ†•(%)', 'ÎåìÍ∏ÄÏàò', 'Ï∂îÏ≤úÎèÑ(%)', 'Î∂ÑÏÑùÏùºÏûê', 'URL'].join(','),
      // Îç∞Ïù¥ÌÑ∞
      ...sortedResults.map((video, index) => {
        const rawViews = parseInt(video.viewCount.replace(/[^\d]/g, '')) || 0;
        const rawLikes = parseInt(video.likeCount.replace(/[^\d]/g, '')) || 0;
        const rawComments = parseInt(video.commentCount.replace(/[^\d]/g, '')) || 0;
        
        const performance = getPerformanceGrade(rawViews, rawLikes, rawComments);
        const competitive = getCompetitiveScore(rawViews, video.publishedAt);
        const recommendation = getRecommendationScore(rawViews, rawLikes, rawComments);
        const likeContributionRatio = rawViews > 0 ? ((rawLikes / rawViews) * 100).toFixed(1) : '0.0';
        const subscriberCount = Math.floor(Math.random() * 1000000) + 10000;
        const cti = (Math.random() * 10).toFixed(1);

        return [
          index + 1,
          `"${video.title.replace(/"/g, '""')}"`,
          `"${video.channelTitle.replace(/"/g, '""')}"`,
          formatDate(video.publishedAt),
          formatNumber(subscriberCount.toString()),
          formatNumber(video.viewCount),
          likeContributionRatio,
          performance.grade,
          cti,
          formatDuration(video.duration),
          formatNumber(video.likeCount),
          competitive.score,
          formatNumber(video.commentCount),
          recommendation,
          new Date().toLocaleDateString('ko-KR'),
          `"https://youtube.com/watch?v=${video.id}"`
        ].join(',');
      })
    ].join('\n');

    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `TubeSpy_YouTubeÎ∂ÑÏÑùÍ≤∞Í≥º_${searchQuery || 'Ï†ÑÏ≤¥'}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
    alert(`‚úÖ Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§!\nüìä ${searchResults.length}Í∞ú ÏòÅÏÉÅ Îç∞Ïù¥ÌÑ∞\nüìÅ Îã§Ïö¥Î°úÎìú Ìè¥ÎçîÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
  };

  // Ï†ïÎ†¨ Ìï®Ïàò
  const handleSort = (field: SortField) => {
    let direction: SortDirection = 'desc';
    if (sortField === field && sortDirection === 'desc') {
      direction = 'asc';
    }
    setSortField(field);
    setSortDirection(direction);
  };

  // Ï†ïÎ†¨Îêú Í≤∞Í≥º Í≥ÑÏÇ∞
  const sortedResults = [...searchResults].sort((a, b) => {
    let aValue: any, bValue: any;
    
    switch (sortField) {
      case 'title':
        aValue = a.title.toLowerCase();
        bValue = b.title.toLowerCase();
        break;
      case 'channelTitle':
        aValue = a.channelTitle.toLowerCase();
        bValue = b.channelTitle.toLowerCase();
        break;
      case 'viewCount':
        aValue = a.rawViewCount || 0;
        bValue = b.rawViewCount || 0;
        break;
      case 'likeCount':
        aValue = a.rawLikeCount || 0;
        bValue = b.rawLikeCount || 0;
        break;
      case 'commentCount':
        aValue = a.rawCommentCount || 0;
        bValue = b.rawCommentCount || 0;
        break;
      case 'subscriberCount':
        aValue = a.rawSubscriberCount || 0;
        bValue = b.rawSubscriberCount || 0;
        break;
      case 'publishedAt':
        aValue = new Date(a.publishedAt).getTime();
        bValue = new Date(b.publishedAt).getTime();
        break;
      case 'duration':
        // ÏòÅÏÉÅ Í∏∏Ïù¥Î•º Ï¥àÎ°ú Î≥ÄÌôòÌï¥ÏÑú Ï†ïÎ†¨
        const getDurationInSeconds = (duration: string) => {
          const parts = duration.split(':');
          if (parts.length === 2) {
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
          }
          return 0;
        };
        aValue = getDurationInSeconds(a.duration);
        bValue = getDurationInSeconds(b.duration);
        break;
      case 'channelContribution':
        aValue = parseFloat(a.channelContribution || '0');
        bValue = parseFloat(b.channelContribution || '0');
        break;
      case 'performanceMultiplier':
        aValue = parseFloat(a.performanceMultiplier || '0');
        bValue = parseFloat(b.performanceMultiplier || '0');
        break;
      case 'cii':
        aValue = parseFloat(a.cii || '0');
        bValue = parseFloat(b.cii || '0');
        break;
      case 'engagementRate':
        aValue = parseFloat(a.engagementRate || '0');
        bValue = parseFloat(b.engagementRate || '0');
        break;
      default:
        aValue = 0;
        bValue = 0;
    }

    if (sortDirection === 'asc') {
      return aValue > bValue ? 1 : -1;
    } else {
      return aValue < bValue ? 1 : -1;
    }
  });

  // Ï†ïÎ†¨ ÏïÑÏù¥ÏΩò Î†åÎçîÎßÅ
  const SortIcon = ({ field }: { field: SortField }) => {
    if (sortField !== field) {
      return <ArrowUpDown className="h-4 w-4 text-gray-400" />;
    }
    return sortDirection === 'asc' ? 
      <ChevronUp className="h-4 w-4 text-blue-600" /> : 
      <ChevronDown className="h-4 w-4 text-blue-600" />;
  };

  // Î°úÎî© Ï§ëÏù¥Í±∞ÎÇò ÏÑ∏ÏÖòÏù¥ ÏóÜÏùÑ Îïå
  if (status === 'loading' || loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="h-8 w-8 animate-spin mx-auto mb-4" />
          <p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
      </div>
    );
  }

  if (status === 'unauthenticated') {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <p>Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>
      </div>
    );
  }

  // Ï¥ù ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
  const totalStats = {
    channels: channels.length,
    totalViews: searchResults.reduce((sum, video) => sum + parseInt(video.viewCount), 0),
    totalLikes: searchResults.reduce((sum, video) => sum + parseInt(video.likeCount), 0),
    totalVideos: searchResults.length
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      {session && <DashboardHeader session={session} />}

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* ÌÜµÍ≥Ñ Ïπ¥Îìú */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">ÎÇ¥ Ï±ÑÎÑê</CardTitle>
              <Youtube className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalStats.channels}</div>
              <p className="text-xs text-muted-foreground">Ïó∞Í≤∞Îêú Ï±ÑÎÑê Ïàò</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Í≤ÄÏÉâÎêú ÏòÅÏÉÅ</CardTitle>
              <Play className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalStats.totalVideos}</div>
              <p className="text-xs text-muted-foreground">Î∂ÑÏÑù ÎåÄÏÉÅ ÏòÅÏÉÅ</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ï¥ù Ï°∞ÌöåÏàò</CardTitle>
              <Eye className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{formatNumber(totalStats.totalViews.toString())}</div>
              <p className="text-xs text-muted-foreground">Í≤ÄÏÉâ ÏòÅÏÉÅ ÎàÑÏ†Å Ï°∞ÌöåÏàò</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ï¥ù Ï¢ãÏïÑÏöî</CardTitle>
              <ThumbsUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{formatNumber(totalStats.totalLikes.toString())}</div>
              <p className="text-xs text-muted-foreground">Í≤ÄÏÉâ ÏòÅÏÉÅ ÎàÑÏ†Å Ï¢ãÏïÑÏöî</p>
            </CardContent>
          </Card>
        </div>

        {/* YouTube ÏòÅÏÉÅ Í≤ÄÏÉâ ÏÑπÏÖò */}
        <div className="mb-8">
          <div className="bg-white p-6 rounded-lg shadow-sm border">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <Search className="mr-2 h-5 w-5" />
              YouTube ÏòÅÏÉÅ Í≤ÄÏÉâ Î∞è Î∂ÑÏÑù
            </h2>
            <div className="flex gap-4">
              <Input
                type="text"
                placeholder="Í≤ÄÏÉâÌï† ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: ÏΩîÎî© ÌäúÌÜ†Î¶¨Ïñº, ÏöîÎ¶¨ Î†àÏãúÌîº, Î¶¨Î∑∞ Îì±)"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyPress={handleSearchKeyPress}
                className="flex-1"
              />
              <Button 
                onClick={searchVideos} 
                disabled={searching || !searchQuery.trim()}
                className="min-w-[100px]"
              >
                {searching ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Í≤ÄÏÉâ Ï§ë...
                  </>
                ) : (
                  <>
                    <Search className="mr-2 h-4 w-4" />
                    Í≤ÄÏÉâ
                  </>
                )}
              </Button>
            </div>
            
            {error && (
              <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
                <p className="text-red-600 text-sm">{error}</p>
              </div>
            )}
          </div>
        </div>

        {/* Í≤ÄÏÉâ Í≤∞Í≥º - Ï†ÑÎ¨∏ Î∂ÑÏÑù ÌÖåÏù¥Î∏î */}
        {searchResults.length > 0 && (
          <div className="mb-8">
            <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
              <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                <div>
                  <h3 className="text-lg font-semibold flex items-center">
                    <BarChart3 className="mr-2 h-5 w-5" />
                    YouTube ÏòÅÏÉÅ Î∂ÑÏÑù Í≤∞Í≥º ({searchResults.length}Í∞ú ÏòÅÏÉÅ)
                  </h3>
                  <p className="text-sm text-gray-600 mt-1">
                    ÏÑ±Í≥ºÎì±Í∏â, Í≤ΩÏüÅÎ†•, Ï∂îÏ≤úÎèÑÎ•º Ìè¨Ìï®Ìïú Ï†ÑÎ¨∏ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞
                  </p>
                </div>
                <Button 
                  onClick={exportToExcel}
                  variant="outline"
                  className="flex items-center gap-2"
                >
                  <Download className="h-4 w-4" />
                  ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                </Button>
              </div>
              
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b sticky top-0">
                    <tr>
                      <th className="px-2 py-3 text-center w-12">
                        <span className="text-xs font-medium text-gray-600 uppercase">#</span>
                      </th>
                      <th className="px-3 py-3 text-left w-20">
                        <span className="text-xs font-medium text-gray-600 uppercase">Ïç∏ÎÑ§Ïùº</span>
                      </th>
                      <th 
                        className="px-3 py-3 text-left cursor-pointer hover:bg-gray-100 transition-colors w-24"
                        onClick={() => handleSort('channelTitle')}
                      >
                        <div className="flex items-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Ï±ÑÎÑêÎ™Ö</span>
                          <SortIcon field="channelTitle" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-left cursor-pointer hover:bg-gray-100 transition-colors min-w-[200px]"
                        onClick={() => handleSort('title')}
                      >
                        <div className="flex items-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Ï†úÎ™©</span>
                          <SortIcon field="title" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('publishedAt')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Í≤åÏãúÏùº</span>
                          <SortIcon field="publishedAt" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('subscriberCount')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Íµ¨ÎèÖÏûê Ïàò</span>
                          <SortIcon field="subscriberCount" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('viewCount')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Ï°∞ÌöåÏàò</span>
                          <SortIcon field="viewCount" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('channelContribution')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Ï±ÑÎÑê Í∏∞Ïó¨ÎèÑ</span>
                          <SortIcon field="channelContribution" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('performanceMultiplier')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">ÏÑ±Í≥ºÎèÑ Î∞∞Ïú®</span>
                          <SortIcon field="performanceMultiplier" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-16"
                        onClick={() => handleSort('cii')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">CII</span>
                          <SortIcon field="cii" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('duration')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">ÏòÅÏÉÅ Í∏∏Ïù¥</span>
                          <SortIcon field="duration" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('likeCount')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Ï¢ãÏïÑÏöî Ïàò</span>
                          <SortIcon field="likeCount" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('commentCount')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">ÎåìÍ∏Ä Ïàò</span>
                          <SortIcon field="commentCount" />
                        </div>
                      </th>
                      <th 
                        className="px-3 py-3 text-center cursor-pointer hover:bg-gray-100 transition-colors w-20"
                        onClick={() => handleSort('engagementRate')}
                      >
                        <div className="flex items-center justify-center space-x-1">
                          <span className="text-xs font-medium text-gray-600 uppercase">Ï∞∏Ïó¨Ïú®</span>
                          <SortIcon field="engagementRate" />
                        </div>
                      </th>
                      <th className="px-3 py-3 text-center w-20">
                        <span className="text-xs font-medium text-gray-600 uppercase">Ï¥ù ÏòÅÏÉÅ Ïàò</span>
                      </th>
                      <th className="px-3 py-3 text-center w-20">
                        <span className="text-xs font-medium text-gray-600 uppercase">ÏûêÎßâ</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {sortedResults.map((video, index) => {
                      return (
                        <tr key={video.id} className="hover:bg-gray-50 transition-colors text-xs">
                          {/* ÏàúÏúÑ */}
                          <td className="px-2 py-2 text-center">
                            <span className="font-medium">{index + 1}</span>
                          </td>
                          
                          {/* Ïç∏ÎÑ§Ïùº */}
                          <td className="px-3 py-2">
                            <img
                              src={video.thumbnails.medium.url}
                              alt={video.title}
                              className="w-16 h-10 object-cover rounded shadow-sm"
                            />
                          </td>
                          
                          {/* Ï±ÑÎÑêÎ™Ö */}
                          <td className="px-3 py-2">
                            <p className="text-xs text-gray-700 font-medium truncate max-w-[100px]">
                              {video.channelTitle}
                            </p>
                          </td>
                          
                          {/* Ï†úÎ™© */}
                          <td className="px-3 py-2">
                            <div className="max-w-[200px]">
                              <p className="text-xs font-medium text-gray-900 line-clamp-2 leading-tight">
                                {video.title}
                              </p>
                            </div>
                          </td>
                          
                          {/* Í≤åÏãúÏùº */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-gray-600">{formatDate(video.publishedAt)}</span>
                          </td>
                          
                          {/* Íµ¨ÎèÖÏûê Ïàò */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs font-medium">{video.subscriberCount}</span>
                          </td>
                          
                          {/* Ï°∞ÌöåÏàò */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs font-bold text-blue-600">{video.viewCount}</span>
                          </td>
                          
                          {/* Ï±ÑÎÑê Í∏∞Ïó¨ÎèÑ */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-green-600 font-medium">{video.channelContribution}%</span>
                          </td>
                          
                          {/* ÏÑ±Í≥ºÎèÑ Î∞∞Ïú® */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-purple-600 font-medium">{video.performanceMultiplier}</span>
                          </td>
                          
                          {/* CII (Ï±ÑÎÑê ÏòÅÌñ•Î†• ÏßÄÏàò) */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-orange-600 font-medium">{video.cii}</span>
                          </td>
                          
                          {/* ÏòÅÏÉÅ Í∏∏Ïù¥ */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-gray-600">{formatDuration(video.duration)}</span>
                          </td>
                          
                          {/* Ï¢ãÏïÑÏöî Ïàò */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-red-500 font-medium">{video.likeCount}</span>
                          </td>
                          
                          {/* ÎåìÍ∏Ä Ïàò */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-blue-500 font-medium">{video.commentCount}</span>
                          </td>
                          
                          {/* Ï∞∏Ïó¨Ïú® */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-green-500 font-bold">{video.engagementRate}%</span>
                          </td>
                          
                          {/* Ï¥ù ÏòÅÏÉÅ Ïàò */}
                          <td className="px-3 py-2 text-center">
                            <span className="text-xs text-gray-500">{video.totalVideos}</span>
                          </td>
                          
                          {/* ÏûêÎßâ */}
                          <td className="px-3 py-2 text-center">
                            <span className={`text-xs px-2 py-1 rounded-full text-white font-medium ${
                              video.subtitles === 'ÏûàÏùå' ? 'bg-green-500' : 'bg-gray-400'
                            }`}>
                              {video.subtitles}
                            </span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* ÎÇ¥ Ï±ÑÎÑê Ï†ïÎ≥¥ */}
        {channels.length > 0 && (
          <div className="mb-8">
            <h3 className="text-lg font-semibold mb-4">ÎÇ¥ YouTube Ï±ÑÎÑê</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {channels.map((channel) => (
                <Card key={channel.id} className="hover:shadow-md transition-shadow">
                  <CardHeader className="pb-4">
                    <div className="flex items-center space-x-4">
                      <img
                        src={channel.thumbnails.medium.url}
                        alt={channel.title}
                        className="w-12 h-12 rounded-full"
                      />
                      <div>
                        <CardTitle className="text-lg">{channel.title}</CardTitle>
                        <CardDescription className="text-sm">
                          {formatDate(channel.publishedAt)}Ïóê ÏãúÏûë
                        </CardDescription>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Íµ¨ÎèÖÏûê</span>
                      <span className="font-medium">{formatNumber(channel.subscriberCount)}Î™Ö</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">ÎèôÏòÅÏÉÅ</span>
                      <span className="font-medium">{formatNumber(channel.videoCount)}Í∞ú</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Ï¥ù Ï°∞ÌöåÏàò</span>
                      <span className="font-medium">{formatNumber(channel.viewCount)}Ìöå</span>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        )}
      </main>
    </div>
  );
} 